<html>
	<head>
		<title>Map Generator test</title>
		<link href="test.css" rel="stylesheet" type="text/css">
	</head>
	<body>
		<div id="grid-display"></div>

		<script src="datagrid.js"></script>
		<script>
			var mapGrid = {};
			mapGrid.terrain = new DataGrid(40,40,["blue"],true,true);
			mapGrid.visuals = new DataGrid(40,40,["blue"],true,true);
			var mapDisplay = document.getElementById('grid-display');
			drawStep = 0;

			function buildGrid(){
				mapGrid.currentDisplayWidth = mapGrid.terrain.width;
				mapGrid.currentDisplayHeight = mapGrid.terrain.height;
				mapDisplay.setAttribute("style","width: "+(mapGrid.currentDisplayWidth)*16+"px;")
				while (mapDisplay.hasChildNodes()) {
				    mapDisplay.removeChild(mapDisplay.lastChild);
				}
				mapGrid.visuals.forAll(addCellToMap);
			};

			function addCellToMap(value){
				var newCell = document.createElement("div");
				newCell.className = "cell " + value;
				mapDisplay.appendChild(newCell);
				return value;
			};

			function copyOverMap(){
				mapGrid.visuals = mapGrid.terrain.clone();
			}

			function drawMap(){
				followInstructions();

				cellcounter = 0;
				if (mapGrid.terrain.width != mapGrid.currentDisplayWidth || mapGrid.terrain.height != mapGrid.currentDisplayHeight){
					buildGrid();
				} else {
					mapGrid.visuals.forAll(setMapCell);
				}
			}

			function setMapCell(value){
				mapDisplay.children[cellcounter].className = "cell " + value;
				cellcounter++;
				return value;
			}

			function randomPointFromCenter(x,y,max){
				var tempX = x - max + Math.floor(Math.random() * (2 * max));
				var tempY = y - max + Math.floor(Math.random() * (2 * max));
				return [tempX,tempY]
			}

			function randomTriangle(x,y,size,value){
				var pointA = randomPointFromCenter(x,y,size);
				var pointB = randomPointFromCenter(x,y,size);
				while (( Math.abs(pointB[0]-pointA[0]) < (size / 4)) || ( Math.abs(pointB[1]-pointA[1]) < (size / 4))){
					pointB = randomPointFromCenter(x,y,size);
				}
				var pointC = randomPointFromCenter(x,y,size);
				while (( Math.abs(pointB[0]-pointC[0]) < (size / 4)) || ( Math.abs(pointB[1]-pointC[1]) < (size / 4)) || 
					( Math.abs(pointA[0]-pointC[0]) < (size / 4)) || ( Math.abs(pointA[1]-pointC[1]) < (size / 4))){
					pointC = randomPointFromCenter(x,y,size);
				}
				mapGrid.terrain.fillPolygon([pointA, pointB, pointC],value);
			}

			function randomCircle(x,y,size,value){
				var xOffset = size - Math.floor( Math.random() * 2 * size);
				var yOffset = size - Math.floor( Math.random() * 2 * size);
				var radius = size - Math.max( Math.abs(xOffset), Math.abs(yOffset) );
				mapGrid.terrain.fillCirc(x + xOffset, y + yOffset, radius, value);
			}

			function expandValue(x1,y1,x2,y2,value,times){
				var mask = mapGrid.terrain.getMaskAll(value);
				mask = DataGrid.expandMask(mask,times);
				mapGrid.terrain.fillRect(x1,y1,x2,y2,value,mask);
			}

			function seedLand(x1,y1,x2,y2){
				var centerX = x1 + Math.floor( (x2 - x1) / 2);
				var centerY = y1 + Math.floor( (y2 - y1) / 2);
				var landMasses = 5 + Math.floor( Math.random() * 10)
				for (var i = 0; i < landMasses; i++) {
					if (Math.random() > 0.5){
						randomTriangle(centerX,centerY, centerX - x1, ["grass","skip","skip","skip"]);
					} else {
						randomCircle(centerX,centerY, centerX - x1, ["grass","skip","skip","skip"]);
					}
				}
			}

			function seedTrees(x1,y1,x2,y2){
				var mask = mapGrid.terrain.getMask(x1,y1,x2,y2,"grass");
				mapGrid.terrain.fillRect(x1,y1,x2,y2,["green","green","skip"],mask);			}

			function seedLandBig(){
				seedLand(1,1,mapGrid.terrain.width - 2,mapGrid.terrain.height - 2);
			}

			function seedTreesBig(){
				seedTrees(1,1,mapGrid.terrain.width - 2,mapGrid.terrain.height - 2);
			}

			function clumpTrees(x1,y1,x2,y2){
				mapGrid.terrain.clumpRect(x1,y1,x2,y2,["green"],"grass");
			}

			function clumpTreesBig(){
				clumpTrees(1,1,mapGrid.terrain.width - 2,mapGrid.terrain.height - 2);
			}

			function expandLandBig(){
				expandValue(1,1,mapGrid.terrain.width - 2,mapGrid.terrain.height - 2, "grass");
				expandValue(1,1,mapGrid.terrain.width - 2,mapGrid.terrain.height - 2, "blue");
			}

			function clearAll(){
				mapGrid.terrain.fillAll("blue");
			};

			function newBigContinent(){
				clearAll();
				seedLandBig();
				expandLandBig();
				seedTreesBig();
			};

			function followInstructions(){
				if( drawStep < instructions.length){
					instructions[drawStep]();
					drawStep++;
				}
			}

			instructions = [
				clearAll,
				copyOverMap,
				seedLandBig,
				copyOverMap,
				expandLandBig,
				copyOverMap,
				seedTreesBig,
				copyOverMap,
				clumpTreesBig,
				copyOverMap
			]

			buildGrid();
			
			drawCycle = setInterval(drawMap, 500);
		</script>
	</body>
</html>